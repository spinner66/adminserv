<?php	// ISSET	if( isset($_GET['cfg']) ){ $path_cfg = $_GET['cfg']; }else{ $path_cfg = null; }	if( isset($_GET['rsc']) ){ $path_rsc = $_GET['rsc']; }else{ $path_rsc = null; }		// INCLUDES	$serverConfig = '../../'.$path_cfg;	if( file_exists($serverConfig) ){		require_once $serverConfig;	}	require_once '../class/GbxRemote.inc.php';	require_once '../class/tmnick.class.php';	require_once '../class/utils.class.php';	$lang = Utils::getLang();	$langFile = '../lang/'.$lang.'.php';	if( file_exists($langFile) ){		require_once $langFile;	}		// DATA	$out = array();	if( class_exists('ServerConfig') ){		if( isset(ServerConfig::$SERVERS) && count(ServerConfig::$SERVERS) > 0 && !isset(ServerConfig::$SERVERS['new server name']) && !isset(ServerConfig::$SERVERS['']) ){						$serverId = 0;			foreach(ServerConfig::$SERVERS as $serverName => $serverValues){				// Connexion				$client = new IXR_ClientMulticall_Gbx;				if( !$client->InitWithIp($serverValues['address'], $serverValues['port']) ){					$out['servers'][$serverId]['error'] = Utils::t('Offline server.');				}				else{					if( !$client->query('Authenticate', 'User', 'User') ){						$out['servers'][$serverId]['error'] = Utils::t('Authentication error.');					}					else{						// Connecté sur						$client->query('GetVersion');						$version = $client->getResponse();						$out['servers'][$serverId]['version']['name'] = $version['Name'];						// Protocole : tmtp ou maniaplanet						$linkProtocol = 'maniaplanet';						if($version['Name'] == 'TmForever'){							$linkProtocol = 'tmtp';						}						$out['servers'][$serverId]['version']['protocol'] = $linkProtocol;												// Jeu						if($version['Name'] == 'TmForever'){							$queryName = array(								'getMapInfo' => 'GetCurrentChallengeInfo',							);						}						else{							$queryName = array(								'getMapInfo' => 'GetCurrentMapInfo',							);						}												// Requêtes						$client->addCall('GetServerName');						$client->addCall('GetSystemInfo');						$client->addCall('GetStatus');						$client->addCall('GetGameMode');						$client->addCall($queryName['getMapInfo']);						$client->addCall('GetPlayerList', array(50, 0) );						$client->addCall('GetMaxPlayers');						$client->multiquery();						$queriesData = $client->getMultiqueryResponse();												// Nom						$out['servers'][$serverId]['name'] = TmNick::toHtml($queriesData['GetServerName'], 10, true, false, '#999');												// Login						$system = $queriesData['GetSystemInfo'];						$out['servers'][$serverId]['serverlogin'] =  $system['ServerLogin'];												// Statut						$status = $queriesData['GetStatus'];						$out['servers'][$serverId]['status'] = $status['Name'];												// GameMode						$gameMode = $queriesData['GetGameMode'];						$gameModeListName = array(							'Script',							'Rounds',							'TimeAttack',							'Team',							'Laps',							'Laps',							'Stunts',							'Cup'						);						if($version['Name'] == 'TmForever'){							$gameMode++;						}						$gameModeName = $gameModeListName[$gameMode];						$out['servers'][$serverId]['gamemode'] = $gameModeName;												// Map						$currentMapInfo = $queriesData[$queryName['getMapInfo']];						$currentMapEnv = $currentMapInfo['Environnement'];						if($currentMapEnv == 'Speed'){							$currentMapEnv = 'Desert'; 						}						else if($currentMapEnv == 'Alpine'){							$currentMapEnv = 'Snow';						}						$currentMapEnvFile = null;						$pathToEnvFile = $path_rsc.'images/env/'.strtolower($currentMapEnv).'.png';						if( file_exists('../../'.$pathToEnvFile) ){							$currentMapEnvFile = $pathToEnvFile;						}						$out['servers'][$serverId]['map']['name'] = TmNick::toHtml(htmlspecialchars($currentMapInfo['Name'], ENT_QUOTES, 'UTF-8'), 10, true, false, '#999');						$out['servers'][$serverId]['map']['env']['name'] = $currentMapEnv;						$out['servers'][$serverId]['map']['env']['filename'] = $currentMapEnvFile;												// Title						$out['servers'][$serverId]['version']['title'] = null;						if($version['Name'] == 'ManiaPlanet'){							switch($currentMapEnv){								case 'Alpine':								case 'Bay':								case 'Canyon':								case 'Coast':								case 'Desert':								case 'Island':								case 'Rally':								case 'Snow':								case 'Speed':								case 'Stadium':									$title = 'TM'.$currentMapEnv;									break;								case 'Storm':									$title = 'SM'.$currentMapEnv;									break;							}							$out['servers'][$serverId]['version']['title'] = $title;						}												// Players						$playerList = $queriesData['GetPlayerList'];						$countPlayerList = count($playerList);						if( $countPlayerList > 0 ){							$playerId = 0;							foreach($playerList as $player){								if($player['IsSpectator'] != 0){ $playerStatus = Utils::t('Spectator'); }else{ $playerStatus = Utils::t('Player'); }								if($player['TeamId'] == 0){ $teamName = Utils::t('Blue'); }else if($player['TeamId'] == 1){ $teamName = Utils::t('Red'); }else{ $teamName = Utils::t('Spectator'); }																$out['players'][$serverId]['list'][$playerId] = array(									'name' => TmNick::toHtml(htmlspecialchars($player['NickName'], ENT_QUOTES, 'UTF-8'), 10, true),									'status' => $playerStatus,									'teamId' => $player['TeamId'],									'teamName' => $teamName								);																$playerId++;							}						}						else{							$out['players'][$serverId]['list'] = Utils::t('No player');						}																		// Count players						$maxPlayers = $queriesData['GetMaxPlayers'];						$out['players'][$serverId]['count']['current'] = $countPlayerList;						$out['players'][$serverId]['count']['max'] = $maxPlayers['NextValue'];					}				}								// Déconnexion				$client->Terminate();				$serverId++;			}		}	}		// Retour	echo json_encode($out);?>