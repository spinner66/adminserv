<?php	// INCLUDES	require_once '../../config/displayserv.cfg.php';	// ServerConfig	if(DisplayServConfig::USE_ADMINSERV_SERVER_CONFIG !== null){		$serverConfig = DisplayServConfig::USE_ADMINSERV_SERVER_CONFIG;	}else{		$serverConfig = '../../config/servers.cfg.php';	}	if( file_exists($serverConfig) ){		require_once $serverConfig;	}	require_once '../displayserv.inc.php';	DisplayServ::getClass();		// DATA	$out = array();	if( class_exists('ServerConfig') ){		if( isset(ServerConfig::$SERVERS) && count(ServerConfig::$SERVERS) > 0 && !isset(ServerConfig::$SERVERS['new server name']) && !isset(ServerConfig::$SERVERS['']) ){						$i = 0;			foreach(ServerConfig::$SERVERS as $serverName => $serverValues){				// Connexion				$client = new IXR_ClientMulticall_Gbx;				if( !$client->InitWithIp($serverValues['address'], $serverValues['port']) ){					$out['error'] = 'Le serveur n\'est pas accessible.';				}				else{					if( !$client->query('Authenticate', 'User', 'User') ){						$out['error'] = 'Echec d\'authentification.';					}					else{						// Connecté sur						$client->query('GetVersion');						$version = $client->getResponse();						$out['servers'][$i]['version'] = $version['Name'];												// Jeu						if($version['Name'] == 'TmForever'){							$queryName = array(								'getMapInfo' => 'GetCurrentChallengeInfo',							);						}						else{							$queryName = array(								'getMapInfo' => 'GetCurrentMapInfo',							);						}												// Requêtes						$client->addCall('GetServerName');						$client->addCall('GetSystemInfo');						$client->addCall('GetStatus');						$client->addCall('GetGameMode');						$client->addCall($queryName['getMapInfo']);						$client->addCall('GetPlayerList', 50, 0);						$client->addCall('GetMaxPlayers');						$client->multiquery();						$queryValues = $client->getResponse();												// Nom						if( isset($queryValues[0][0]) ){							$out['servers'][$i]['name'] = TmNick::toHtml($queryValues[0][0], 10, true, false, '#999');						}												// Login						if( isset($queryValues[1][0]) ){							$system = $queryValues[1][0];							$out['servers'][$i]['serverlogin'] =  $system['ServerLogin'];						}												// Statut						if( isset($queryValues[2][0]) ){							$status = $queryValues[2][0];							$out['servers'][$i]['status'] = $status['Name'];						}												// GameMode						if( isset($queryValues[3][0]) ){							$gameMode = $queryValues[3][0];							switch($gameMode){								case 0:									$gameModeName = 'Script';									break;								case 1:									$gameModeName = 'Round';									break;								case 2:									$gameModeName = 'TimeAttack';									break;								case 3:									$gameModeName = 'Team';									break;								case 4:									$gameModeName = 'Laps';									break;								case 5:									$gameModeName = 'Stunt';									break;								case 6:									$gameModeName = 'Cup';									break;							}							$out['servers'][$i]['gamemode'] = $gameModeName;						}												// Map						if( isset($queryValues[4][0]) ){							$currentMapInfo = $queryValues[4][0];							$currentMapEnv = $currentMapInfo['Environnement'];							if($currentMapEnv == 'Speed'){								$currentMapEnv = 'Desert'; 							}							else if($currentMapEnv == 'Alpine'){								$currentMapEnv = 'Snow';							}							$out['servers'][$i]['map']['name'] = htmlspecialchars($currentMapInfo['Name'], ENT_QUOTES, 'UTF-8');							$out['servers'][$i]['map']['env'] = $currentMapEnv;						}												// Players						if( isset($queryValues[5][0]) ){							$out['players'][$i]['list'] = $queryValues[5][0];						}						else{							$out['players'][$i]['list'] = array();						}												// Count players						if( isset($queryValues[6][0]) ){							$maxPlayers = $queryValues[6][0];							$out['players'][$i]['count']['current'] = count($out['players'][$i]['list']);							$out['players'][$i]['count']['max'] = $maxPlayers['NextValue'];						}					}				}								// Déconnexion				$client->Terminate();				$i++;			}		}	}		// Retour	echo json_encode($out);?>